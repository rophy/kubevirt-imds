apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: imds-webhook
  annotations:
    # This annotation tells cert-manager to inject the CA bundle
    # Comment out if using manual cert generation
    # cert-manager.io/inject-ca-from: kubevirt-imds/imds-webhook-cert
webhooks:
- name: imds.kubevirt.io
  admissionReviewVersions: ["v1"]
  sideEffects: None
  timeoutSeconds: 10
  # Only match pods in namespaces with the label
  namespaceSelector:
    matchExpressions:
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - kube-system
      - kubevirt-imds
  objectSelector:
    matchLabels:
      kubevirt.io: virt-launcher
  rules:
  - apiGroups: [""]
    apiVersions: ["v1"]
    operations: ["CREATE"]
    resources: ["pods"]
    scope: Namespaced
  clientConfig:
    service:
      name: imds-webhook
      namespace: kubevirt-imds
      path: /mutate
      port: 443
    # CA bundle will be injected by cert-manager or manually
    # caBundle: <base64-encoded-ca-cert>
  failurePolicy: Fail
  reinvocationPolicy: Never
